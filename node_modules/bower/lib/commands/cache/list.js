var mout = require('mout');
var Logger = require('bower-logger');
var PackageRepository = require('../../core/PackageRepository');
var cli = require('../../util/cli');
var defaultConfig = require('../../config');

/**
 * Description
 * @method list
 * @param {} packages
 * @param {} options
 * @param {} config
 * @return logger
 */
function list(packages, options, config) {
    var repository;
    var logger = new Logger();

    config = mout.object.deepFillIn(config || {}, defaultConfig);
    repository = new PackageRepository(config, logger);

    // If packages is an empty array, null them
    if (packages && !packages.length) {
        packages = null;
    }

    repository.list()
    .then(function (entries) {
        if (packages) {
            // Filter entries according to the specified packages
            entries = entries.filter(function (entry) {
                return !!mout.array.find(packages, function (pkg) {
                    return pkg === entry.pkgMeta.name;
                });
            });
        }

        return entries;
    })
    .done(function (entries) {
        logger.emit('end', entries);
    }, function (error) {
        logger.emit('error', error);
    });

    return logger;
}

// -------------------

/**
 * Description
 * @method line
 * @param {} argv
 * @return CallExpression
 */
list.line = function (argv) {
    var options = list.options(argv);
    return list(options.argv.remain.slice(2), options);
};

/**
 * Description
 * @method options
 * @param {} argv
 * @return CallExpression
 */
list.options = function (argv) {
    return cli.readOptions(argv);
};

/**
 * Description
 * @method completion
 * @return 
 */
list.completion = function () {
    // TODO:
};

module.exports = list;
