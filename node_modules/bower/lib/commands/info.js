var mout = require('mout');
var Q = require('q');
var Logger = require('bower-logger');
var endpointParser = require('bower-endpoint-parser');
var PackageRepository = require('../core/PackageRepository');
var cli = require('../util/cli');
var defaultConfig = require('../config');

/**
 * Description
 * @method info
 * @param {} endpoint
 * @param {} property
 * @param {} config
 * @return logger
 */
function info(endpoint, property, config) {
    var repository;
    var decEndpoint;
    var logger = new Logger();

    config = mout.object.deepFillIn(config || {}, defaultConfig);
    repository = new PackageRepository(config, logger);

    decEndpoint = endpointParser.decompose(endpoint);

    Q.all([
        getPkgMeta(repository, decEndpoint, property),
        decEndpoint.target === '*' && !property ? repository.versions(decEndpoint.source) : null
    ])
    .spread(function (pkgMeta, versions) {
        if (versions) {
            return {
                name: decEndpoint.source,
                versions: versions,
                latest: pkgMeta
            };
        }

        return pkgMeta;
    })
    .done(function (result) {
        logger.emit('end', result);
    }, function (error) {
        logger.emit('error', error);
    });

    return logger;
}

/**
 * Description
 * @method getPkgMeta
 * @param {} repository
 * @param {} decEndpoint
 * @param {} property
 * @return CallExpression
 */
function getPkgMeta(repository, decEndpoint, property) {
    return repository.fetch(decEndpoint)
    .spread(function (canonicalDir, pkgMeta) {
        pkgMeta = mout.object.filter(pkgMeta, function (value, key) {
            return key.charAt(0) !== '_';
        });

        // Retrieve specific property
        if (property) {
            pkgMeta = mout.object.get(pkgMeta, property);
        }

        return pkgMeta;
    });
}

// -------------------

/**
 * Description
 * @method line
 * @param {} argv
 * @return CallExpression
 */
info.line = function (argv) {
    var options = info.options(argv);
    var pkg = options.argv.remain[1];
    var property = options.argv.remain[2];

    if (!pkg) {
        return null;
    }

    return info(pkg, property);
};

/**
 * Description
 * @method options
 * @param {} argv
 * @return CallExpression
 */
info.options = function (argv) {
    return cli.readOptions(argv);
};

/**
 * Description
 * @method completion
 * @return 
 */
info.completion = function () {
    // TODO:
};

module.exports = info;
