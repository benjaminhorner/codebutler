var mout = require('mout');
var Logger = require('bower-logger');
var Project = require('../core/Project');
var cli = require('../util/cli');
var defaultConfig = require('../config');

/**
 * Description
 * @method prune
 * @param {} config
 * @return logger
 */
function prune(config) {
    var project;
    var logger = new Logger();

    config = mout.object.deepFillIn(config || {}, defaultConfig);
    project = new Project(config, logger);

    clean(project)
    .done(function (removed) {
        logger.emit('end', removed);
    }, function (error) {
        logger.emit('error', error);
    });

    return logger;
}

/**
 * Description
 * @method clean
 * @param {} project
 * @param {} removed
 * @return CallExpression
 */
function clean(project, removed) {
    removed = removed || {};

    // Continually call clean until there is no more extraneous
    // dependencies to remove
    return project.getTree()
    .spread(function (tree, flattened, extraneous) {
        var names = extraneous.map(function (extra) {
            return extra.endpoint.name;
        });

        // Uninstall extraneous
        project.uninstall(names)
        .then(function (uninstalled) {
            // Are we done?
            if (!mout.object.size(uninstalled)) {
                return removed;
            }

            // Not yet, recurse!
            mout.object.mixIn(removed, uninstalled);
            return clean(project, removed);
        });
    });
}

// -------------------

/**
 * Description
 * @method line
 * @return CallExpression
 */
prune.line = function () {
    return prune();
};

/**
 * Description
 * @method options
 * @param {} argv
 * @return CallExpression
 */
prune.options = function (argv) {
    return cli.readOptions(argv);
};

/**
 * Description
 * @method completion
 * @return 
 */
prune.completion = function () {
    // TODO:
};

module.exports = prune;
